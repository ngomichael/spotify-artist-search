<!DOCTYPE html>
<!--Michael Ngo
  3/11/17
  http://mngo.greenrivertech.net/207/finalProject.html
  This page loads an artists top songs and related artists-->

<!--//Client ID - a7f97cce8bc148568b050bde1fc86020
//Client Secret - fdf579aefac941de8c82691b4567661b-->
<html>
<head>
    <meta charset="UTF-8">
    <title>Artist's Top Songs</title>
    <link rel="stylesheet" type="text/css" href="finalStyles.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

</head>

<body>
<div id="artistSearchContainer">
    <div id=inputAndButtonContainer>
        <input id="artist" placeholder="Artist" type="text">
        <button id="displayResultsButton">Search</button>
    </div>
    <h1 id="artistName">Enter an artist to see their top songs!</h1>
</div>

<div id=artistInfoContainer>
    <div id="topTracks"></div>
    <img id="artistImg" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" height=300 alt="artistImage">
    <div id="relatedArtists"></div>
</div>

<p id="error"></p>

<script src="http://code.jquery.com/jquery.js"></script>

<script>
    var currentlyPlayingTrack = null;
    var trackElements = null;
    var otherArtistsElements = null;
    var topTracks = [];
    var trackPreviews = [];

    //Creates an audio element and plays it
    function playMusic(url) {
        var music = new Audio(url);
        currentlyPlayingTrack = music;
        currentlyPlayingTrack.play();
    }

    //Pauses the audio element that was created in playMusic
    function pauseMusic() {
        currentlyPlayingTrack.pause();
        currentlyPlayingTrack = null;
    }

    //Adds a mouse over event onto the each song element on the page
    function addMouseOver(trackNumber) {
        $(trackElements[trackNumber]).mouseover(function() {
            playMusic(trackPreviews[trackNumber]);
        });
    }

    //Adds a mouse out event onto the each song element on the page
    function addMouseOut(trackNumber) {
        $(trackElements[trackNumber]).mouseout(function() {
            pauseMusic();
        });
    }

    //Adds a click event onto the each related artist element on the page
    function addclick(index) {
        $(otherArtistsElements[index]).click(function() {
            displayInformation(otherArtistsElements[index]);
        });
    }

    $('#artist').keypress(function(e) {
        var key = e.which;
        if(key == 13) {
            $('#displayResultsButton').click();
        }
    });

    //Displays the artist's top ten songs, image, name, and related artists on the page when called
    function displayInformation(artistInput) {
        //Clears the page
        $('#artistName').html(" ");
        $('#topTracks').html(" ");
        $('#relatedArtists').html(" ");
        $('#artistImg').attr('src', '');
        var inputVal = artistInput.innerHTML;
        topTracks = [];
        trackPreviews = [];
        trackElements = null;
        otherArtistsElements = null;

        //Changes styles of elements on the page
        inputAndButtonContainer.style.top = '3%';
        inputAndButtonContainer.style.left = '7%';
        artist.style.height = '20px';
        artist.style.width = '175px';
        artist.style.fontSize = '16px';

        displayResultsButton.style.height = '29px';
        displayResultsButton.style.width = '95px';
        displayResultsButton.style.fontSize = '16px';

        artistName.style.marginTop = '5px';

        //Gets the artist's image and name
        $.getJSON('https://api.spotify.com/v1/search?q=' + inputVal + '&type=artist', function(result) {
            var artistId = result.artists.items[0].id;
            $.each(result, function(index, item) {
                $('#artistName').append(item.items[0].name);
                $('#artistImg').attr('src', item.items[0].images[0].url);
                $('#topTracks').append('<h2>' + item.items[0].name + "'s Top 10 Tracks!" + '</h2>');
            });

            //Gets the top ten tracks from an artist and displays it on the page
            $.getJSON('https://api.spotify.com/v1/artists/' + artistId + '/top-tracks?country=US', function(result) {
                var counter = 1;
                $.each(result, function(index, item) {
                    $.each(item, function(index, track) {
                        var musicTrack = track.preview_url;
                        var trackName = track.name;
                        $('#topTracks').append("<span>" + counter + ': ' + trackName + "</span>" + "<br>");
                        topTracks.push(trackName);
                        trackPreviews.push(musicTrack);
                        counter++;
                    });
                });
                $('#topTracks span').addClass('tracks');
                var tracks = document.getElementsByClassName('tracks');
                trackElements = tracks;

                for(var i = 0; i < tracks.length; i++) {
                    addMouseOver(i);
                    addMouseOut(i);
                }
            });

            //Gets an artist's top 5 related artist's and displays it on the page.
            $.getJSON('https://api.spotify.com/v1/artists/' + artistId + '/related-artists', function(result) {
                var counter = 0;
                $('#relatedArtists').append('<h2> Related Artists </h2>');
                $.each(result, function(index, item) {
                    $.each(item, function(index, artist) {
                        if(counter >= 5) {
                            return;
                        }
                        var relatedArtist = artist.name;
                        $('#relatedArtists').append("<span>" + relatedArtist + "</span>" + "<br>");
                        counter++;
                    });
                });

                $('#relatedArtists span').addClass('otherArtists');
                var otherArtists = document.getElementsByClassName('otherArtists');
                otherArtistsElements = otherArtists;

                for(var j = 0; j < otherArtistsElements.length; j++) {
                    addclick(j);
                }
            });
        });
    }

    try
    {
        $('#displayResultsButton').click(function() {
            //Clears the page
            $('#artistName').html(" ");
            $('#topTracks').html(" ");
            $('#relatedArtists').html(" ");
            $('#artistImg').attr('src', '');
            topTracks = [];
            trackPreviews = [];
            trackElements = null;
            otherArtistsElements = null;

            //Changes styles of elements on the page
            inputAndButtonContainer.style.top = '3%';
            inputAndButtonContainer.style.left = '8%';
            artist.style.height = '20px';
            artist.style.width = '175px';
            artist.style.fontSize = '16px';

            displayResultsButton.style.height = '29px';
            displayResultsButton.style.width = '95px';
            displayResultsButton.style.fontSize = '16px';

            artistName.style.marginTop = '5px';

            //Gets the artist's image and name
            $.getJSON('https://api.spotify.com/v1/search?q=' + $('#artist').val() + '&type=artist', function(result) {
                var artistId = result.artists.items[0].id;
                $.each(result, function(index, item) {
                    $('#artistName').append(item.items[0].name);
                    $('#artistImg').attr('src', item.items[0].images[0].url);
                    $('#topTracks').append('<h2>' + item.items[0].name + "'s Top 10 Tracks!" + '</h2>');
                });

                //Gets the top ten tracks from an artist and displays it on the page
                $.getJSON('https://api.spotify.com/v1/artists/' + artistId + '/top-tracks?country=US', function(result) {
                    var counter = 1;
                    $.each(result, function(index, item) {
                        $.each(item, function(index, track) {
                            var musicTrack = track.preview_url;
                            var trackName = track.name;
                            $('#topTracks').append("<span>" + counter + ': ' + trackName + "</span>" + "<br>");
                            topTracks.push(trackName);
                            trackPreviews.push(musicTrack);
                            counter++;
                        });
                    });
                    $('#topTracks span').addClass('tracks');
                    var tracks = document.getElementsByClassName('tracks');
                    trackElements = tracks;

                    for(var i = 0; i < tracks.length; i++) {
                        addMouseOver(i);
                        addMouseOut(i);
                    }
                });

                //Gets an artist's top 5 related artist's and displays it on the page.
                $.getJSON('https://api.spotify.com/v1/artists/' + artistId + '/related-artists', function(result) {
                    var counter = 0;
                    $('#relatedArtists').append('<h2> Related Artists </h2>');
                    $.each(result, function(index, item) {
                        $.each(item, function(index, artist) {
                            if(counter >= 5) {
                                return;
                            }
                            var relatedArtist = artist.name;
                            $('#relatedArtists').append("<span>" + relatedArtist + "</span>" + "<br>");
                            counter++;
                        });
                    });
                    $('#relatedArtists span').addClass('otherArtists');
                    var otherArtists = document.getElementsByClassName('otherArtists');
                    otherArtistsElements = otherArtists;

                    for(var j = 0; j < otherArtistsElements.length; j++) {
                        addclick(j);
                    }
                });
            });
        });
    }
    catch (exception)
    {
        $('#error').append("Sorry, there was an error");
    }
</script>
</body>
</html>